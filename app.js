// Generated by CoffeeScript 1.7.1
(function() {
  var COLLECTION_NAME, DOCROOT, S, fs, getCommand, getHandler, http, log, mongo, mongoClient, mongoUri, port, postCommand, querystring, server, url, uuid;

  http = require('http');

  fs = require('fs');

  mongo = require('mongodb');

  log = console.log;

  url = require('url');

  S = require('string');

  querystring = require('querystring');

  uuid = require('node-uuid');

  mongoUri = process.env.MONGOHQ_URL || 'mongodb://localhost/mydb';

  mongoClient = mongo.MongoClient;

  DOCROOT = "documents";

  COLLECTION_NAME = "test";

  getHandler = function(filepath, req, res) {
    return fs.readFile(filepath, "utf-8", function(err, data) {
      var header;
      if (err) {
        throw err;
      }
      header = {
        "Content-type": ""
      };
      if (S(filepath).endsWith(".css")) {
        header["Content-type"] = "text/css";
      } else if (S(filepath).endsWith(".html")) {
        header["Content-type"] = "text/html";
      } else if (S(filepath).endsWith(".js")) {
        header["Content-type"] = "application/javascript";
      }
      res.writeHead(200, header);
      return res.end(data);
    });
  };

  postCommand = function(command, user, date, desc) {
    return mongoClient.connect(mongoUri, function(err, db) {
      var collection, id;
      if (err) {
        throw err;
      }
      collection = db.collection(COLLECTION_NAME);
      log('removing documents');
      id = uuid.v1();
      return collection.remove((function(err, result) {
        var oneData;
        if (err) {
          throw err;
        }
        log("colelction cleared!");
        oneData = {
          "id": id,
          "date": date,
          "data": {
            "command": command,
            "user": user,
            "desc": desc
          }
        };
        return collection.insert(oneData, function(err, docs) {
          if (err) {
            throw err;
          }
          log("Just inserted, " + docs.length);
          return collection.find({}).toArray(function(err, docs) {
            if (err) {
              throw err;
            }
            return docs.forEach(function(doc) {
              return log("found document:" + doc.data.command);
            });
          });
        });
      }));
    });
  };

  getCommand = function() {
    return mongoClient.connect(mongoUri, function(err, db) {
      var collection, docs;
      if (err) {
        throw err;
      }
      collection = db.collection(COLLECTION_NAME);
      docs = collection.find({}, {
        limit: 5
      });
      return docs.count(function(err, count) {
        log(" " + count + " document(s) fund");
        log("==========================");
        return docs.toArray(function(err, docs) {
          var doc, _i, _len, _results;
          if (err) {
            throw err;
          }
          _results = [];
          for (_i = 0, _len = docs.length; _i < _len; _i++) {
            doc = docs[_i];
            _results.push(log(doc));
          }
          return _results;
        });
      });
    });
  };

  server = http.createServer(function(req, res) {
    var filepath, isIgnore, params, pathname, query;
    filepath = '';
    isIgnore = false;
    pathname = url.parse(req.url).pathname;
    log("pathname=" + pathname);
    if (pathname === '/') {
      filepath = DOCROOT + "/index.html";
      getHandler(filepath, req, res);
    } else if (pathname === '/favicon.ico') {
      res.writeHead(404);
    } else if (pathname === "/postCommand") {
      query = url.parse(req.url).query;
      params = querystring.parse(query);
      postCommand(params.command, params.user, params.date, params.desc);
      return res.writeHead(200);
    } else {
      filepath = DOCROOT + req.url;
      getHandler(filepath, req, res);
    }
  });

  getCommand();

  port = process.env.PORT || 5000;

  server.listen(port, function() {
    return log("http server listening on port " + server.address().port);
  });

}).call(this);
